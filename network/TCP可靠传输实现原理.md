预备知识：TCP报文格式字段
------------

1、分为首部和数据两部分，二十个字节固定首部；

2、分析：           
1）两个字节源端口、两个字节目的端口；

2）四个字节序号（报文段序号）、四个字节确认号（期望收到对方下一个报文段的第一个数据字节的序号）；

3）四位数据偏移、六位保留、六位控制位：紧急URG、确认ACK、推送PSH、复位RST、同步SYN、终止FIN；

4）两字节窗口（窗口值作为接收方让发送方设置其发送窗口的依据）；    

5）两字节检验和（检验方法类似UDP，加伪首部）、两字节紧急指针（结合紧急控制位URG）；

6）最大四十个字节选项，包括MSS（最大报文段长度，默认536）、十字节时间戳（时间戳值、时间戳回送回答，计算RTT，防止序号绕回）等

#### 一、理想条件：

传输信道不产生差错；与速度无关，接收方总能及时处理收到的数据。

#### 二、简单的可靠传输：

停止等待协议：每发送完一个分组就停止发送，等待对方确认。收到确认再发送下一个分组。        
1、无差错情况；        
2、出现差错：设置超时计时器。

注意三点：1）发送方保留分组副本；2）分组和确认分组进行编号；3）超时计时器比平均往返时间长一些。 

3、确认丢失和确认迟到： 

超时。重新发送分组，接收方两个个操作：
1）丢弃重复分组；
2）向A发送确认；        

这种可靠传输机制也称ARQ（自动重传请求）         
特点：接收方不用请求发送方重传某个出错分组；信道利用率低。         改进：连续ARQ协议（流水线传输）与滑动窗口协议三、实际中的可靠传输：       
1、滑动窗口协议：  
* 发送窗口与接收窗口不总是一样大；发送方和接收方各自维护一个发送窗口和接收窗口，单位是字节           
* 对于不按序到达的数据不丢弃，临时存放在接收窗口中；            
* 接收方必须有累计确认功能；  
* 
2、超时重传时间的选择：TCP中记录发送时间和接收到的时间RTT      

平均往返时间RTT，加权平均往返时间RTTs         

      新RTTs =（1 - a）*（旧的RTTs）+ a *（新的RTT样本）（0 <= a < 1，推荐0.125）
      
超时重传时间RTO，RTT偏差的加权平均值RTTd    

    RTO = RTTs + 4 x RTTd   
    
    新的RTTd =（1 - y）*（旧的RTTd）+ y * |RTTs –新的RTT样本| （y推荐0.25）  

在计算平均加权RTTs时，只要报文段重传了，就不采用其往返时间样本。这样RTTs和RTO比较精确； 

3、选择确认SACK如果收到的报文段无差错，只是未按序号，中间缺少一些序号数据。可以在首部添加选项“选择确认”记录缺少序号段的边界，在建立连接时协商。   

以上为一些要点记录，详细请参考《计算机网络（第七版）》谢希仁

作者：chen_yongzu
链接：https://www.jianshu.com/p/a9c9c178b21c
来源：简书
简书著作权归作者所有，任何形式的转载都请联系作者获得授权并注明出处。