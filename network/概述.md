分层
------

一、TCP/IP通常被认为是一个四层协议系统，主要是链路层、网络层、运输层和应用层。
每一层的功能如下：
1) 链路层，有时也称作数据链路层或网络接口层，通常包括操作系统中的设备驱动程序和计算机中对应的网络接口卡。它们一起处理与电缆（或其他任何传输媒介）的物理接口细节。
2) 网络层，有时也称作互联网层，处理分组在网络中的活动，例如分组的选路。在TCP/IP协议族中，网络层协议包括IP协议（网际协议），ICMP协议（Internet互联网控制报文协议），以及IGMP协议（Internet组管理协议）。
3) 运输层主要为两台主机上的应用程序提供端到端的通信。在TCP/IP协议族中，有两个互不相同的传输协议：TCP（传输控制协议）和UDP（用户数据报协议）。

TCP为两台主机提供高可靠性的数据通信。它所做的工作包括把应用程序交给它的数据分成合适小块交给下面的网络层，确认接收到的分组，设置发送最后确认分组的超时时钟等。由于运输层提供了高可靠性的端到端的通信，因此应用层可以忽略所有这些细节。

UDP则为应用层提供了一种非常简单的服务。它只是把称作数据报的分组从一台主机发送到另一台主机，但并不能保证该数据报能到达另一端。任何必须的可靠性必须由应用层提供。

4) 应用层负责处理特定的应用程序细节。几乎各种不同的TCP/IP实现都会提供下面这些通用的应用程序：
* Telnet远程登陆。
* FTP文件传输协议。
* SMTP简单邮件传送协议。
* SNMP简单网络管理协议。

二、在TCP/IP协议族中，网络层IP提供的是一种不可靠的服务。也就是说它只是尽可能快地把分组从源节点送到目的节点，但是并不提供任何可靠性保证。而另一方面，TCP在不可靠的IP层上提供了一个可靠的运输层。为了提供这种可靠的服务，TCP采用了超时重传、发送和接收端到端的确认分组等机制。

三、连接网络的途径
* 连接网络的一个途径是路由器。一个路由器具有两个或多个网络接口层（因为它连接了两个或多个网络）。
* 连接网络的另一个途径是使用网桥。网桥是在链路层上对网络进行互连，而路由器则是在网络层上对网络进行互连。网桥使得多个局域网（LAN）组合在一起，这样对上层来说就好像是一个局域网。

四、ARP和RARP协议

ARP（地址解析协议）和RARP（逆地址解析协议）是某些网络接口（如以太网和令牌环网）使用的特殊协议，用来转换IP层和网络接口层使用的地址。

五、以太网数据帧的物理特性是其长度必须在46~1500字节之间。

链路层
-------
一、在TCP/IP协议族中，链路层主要有三个目的：
1. 为IP模块发送和接收IP数据报；
2. 为ARP模块发送ARP请求和接收ARP应答；
3. 为RARP发送RARP请求和接受RARP应答。


二、数据链路层的封包结构

```
-------------------------------------------------
| 目的地址 | 源地址 |类  型|     数据     |  CRC  |
-------------------------------------------------

|<-  6  ->|<- 6  ->|<-2->|<-  46~1500 ->|<- 4 ->|
```

* 目的地址和源地址采用48bit(6字节)，也就是硬件地址。（ARP和RARP协议对32bit的IP地址和48bit的硬件地址进行映射。
* 类型字段定义了后续数据的类型，0800为IP数据报，0806为ARP请求和应答，8035为RARP请求和应答
* 数据字段，以太网协议要求数据字段最少要46字节。
* CRC字段用于帧内后续字节差错的循环冗余码检验（校验和）

二、最大传输单元

以太网和802.3对数据帧的长度都有一个限制，其最大值分别是1500和1492字节。链路层的这个特性称作MTU，最大传输单元。

三、路径MTU

如果两台主机之间的通信要通过多个网络，那么每个网络的链路层可能有不同的MTU。重要的不是两台主机所在网络的MTU值，重要的是两台通信主机路径中的最小MTU。它被称作路径MTU。

网际协议
--------
一、网际协议提供不可靠、无连接的数据报传送服务
* 不可靠(unreliable)的意思是它不能保证IP数据报能成功到达目的地。
* 无连接(connectionless)的意思是IP并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先是A，然后是B），每个数据报都是独立地进行路由选择，可能选择不同的线路，因此B可能在A到达之前先到达 。

二、普通IP首部长为20个字节

```shell
-------------------------------------------------------------------------
|4位版本号|4位首部长度|8位服务类型(TOS)|        16位总长度（字节数)         |
-------------------------------------------------------------------------
|       16位标识                     |3位标志|       13位片偏移           |
-------------------------------------------------------------------------
|  8位生存时间(TTL)  |   8位协议      |    16位首部校验和                  |
-------------------------------------------------------------------------
|                            32位源IP地址                                |
-------------------------------------------------------------------------
|                           32位目的IP地址                               |
-------------------------------------------------------------------------
|                             选项(如果有)                               |
-------------------------------------------------------------------------
```

* 版本号4或6
* 首部长度指的是首部占32bit字的数目，包括任何选项。由于它是一个4比特字段，因此首部最长为60字节。**因为第一个值是2^4=16，最大值是15，15*4=60，故首部最长为60字节**
* 服务类型（TOS）字段包括一个3bit的优先权子字段（现已被忽略），4bit的TOS子字段和1bit未用位但必须置0。4bit的TOS分别代表：最小时延、最大吞吐量、最高可靠性和最小费用。4bit中只能置其中1bit。如果所有4bit均为0，那么就意味着是一般服务。
* 总长度字段是指整个IP数据报的长度，以字节为单位。利用首部长度字段和总长度字段，就可以知道IP数据报中数据内容的起始位置和长度。
* 标识字段唯一地标识主机发送的每一份数据报。通常每发送一份报文它的值就会加1。
* 标志字段
* 片偏移字段
* TTL(time-to-live)生存时间字段设置了数据报可以经过的最多路由器数。它指定了数据报的生存时间。TTL的初始值由源主机设置（通常为32或64），一旦经过一个处理它的路由器，它的值就减去1。当该字段的值为0时，数据报就被丢弃，发送ICMP报文通知源主机。
* 协议字段识别是哪个协议向IP传送数据。
* 首部校验和字段是根据IP首部计算的检验和码。它不对首部后面的数据进行计算。ICMP、IGMP、UDP和TCP在它们各自的首部中均含有同时覆盖首部和数据检验和码。
* 每一份IP数据报都含有IP地址和目的IP地址。
* 选项是数据报中的一个可变长的可选信息。选项字段很少被使用，并非所有的主机和路由器都支持这些选项。

三、网络传输是以大端序进行

四、主机和路由器的区别：
主机从不把数据报从一个接口转发到另一个接口，而路由器则要转发数据报。

五、IP路由选择

如果目的主机与源主机直接相连（如点对点链路）或都在一个共享网络上（以太网或令牌环网），那么IP数据报就直接送到目的主机上。否则，主机把数据报发往一默认的路由器上，由路由器转发该数据报。

IP层在内存中有一个路由表，当收到一份数据报并进行转发时，它都要对该表搜索一次。当数据报来自某个网络接口时，IP首先检查目的IP地址是否为本机的IP地址之一或者IP广播地址。如果确实是这样，数据报就被送到由IP首部协议字段所指定的协议模块进行处理。如果数据报的目的不是这些地址，那么（1）如果IP层被设置为路由器的功能，那么就对数据报进行转发（也就是说，像下面对待发出的数据报一样处理）；否则（2）数据报被丢弃。

ARP协议
--------

一、ARP为IP地址到对应的硬件地址之间提供动态映射

二、ARP协议
```shell
|以太网目的地址|以太网源地址|帧类型|硬件类型|协议类型|硬件地址长度|协议地址长度|op|发送端以太网地址|发送端IP地址|目的以太网地址|目的IP地址|
```

* 以太网目的地址、以太网源地址和帧类型为以太网首部
* 以太网帧类型表示后面数据的类型，对于ARP请求或应答来说，该字段值为0x0806
* 硬件类型字段表示硬件地址的类型。它的值1即表示以太网地址。
* 协议类型字段标识要映射的协议地址类型。它的值为0x0800即表示IP地址。
* 硬件地址长度和协议地址长度分别指出硬件地址和协议地址的长度，以字节为单位。对于以太网上IP地址的ARP请求或应答来说，它们的值分别为6和4。
* 操作字段（op）指出四种操作类型，它们是ARP请求（值为1）、ARP应答（值为2）、RARP请求（值为3）和RARP应答（值为4）。
* 接下来的四个字段是发送端的硬件地址（即以太网地址）、发送端的协议地址（IP地址）、目的端的硬件地址和目的端的协议地址。

RARP逆地址解析协议
------


ICMP: Internet控制报文协议
-------

一、ICMP传递差错报文以及其他需要注意的信息。

二、在对ICMP差错报文进行相应时，永远不会生成另一份ICMP差错报文。

三、ICMP协议

```shell
| 8位类型 | 8位代码 |       16位校验和       |
|                                          |
|       （不同类型和代码有不同的内容）        |
|                                          |
```
* 类型字段可以有15个不同的值，以描述特定类型的ICMP报文
* 某些ICMP报文还可以使用代码字段的值来进一步描述不通的条件
* 检验和字段覆盖整个ICMP报文，使用的算法与IP首部检验和算法相同

四、当发送一份ICMP差错报文时，报文始终包含IP的首部和产生ICMP差错报文的IP数据报的前8个字节。这样，接收ICMP差错报文的模块就会把它与某个特定的协议（根据IP数据报首部中的协议字段来判断）和用户进程（根据包含在IP数据报前8个字节中的TCP或UDP报文首部中的TCP或UDP端口号来判断）联系起来。

五、下面各种情况都不会导致产生ICMP差错报文：
* ICMP差错报文（但是，ICMP查询报文可能产生ICMP差错报文）。
* 目的地址时广播地址或多播地址。
* 作为链路层广播的数据报。
* 不是IP分片的第一片
* 源地址不是单个主机的数据报。这就是说，源地址不能为零地址、环回地址、广播地址或多播地址。

UDP：用户数据报协议
---------
一、UDP是一个简单的面向数据报的运输层协议。

二、UDP首部
```shell
-----------------------------------------------
|       16位源端口号      |   16位目的端口号     |
-----------------------------------------------
|       16位UDP长度       |    16位UDP检验和    |
-----------------------------------------------
|                数据（如果有）                 |
-----------------------------------------------
```
* 端口号表示发送进程和接收进程
* UDP长度字段指的是UDP首部和UDP数据的字节长度。
* UDP和TCP在首部中都有覆盖它们首部和数据的检验和。UDP的检验和是可选的，而TCP的检验和是必需的。
* UDP数据报和TCP段都包含一个12字节长的伪首部，它是为了计算检验和而设置的。伪首部包含IP首部一些字段。

TCP：传输控制协议
---------
一、协议
```shell
---------------------------------------------------------------------------  
|               16位源端口号             |           16位目的端口号           |
---------------------------------------------------------------------------
|                                    32位序号                               |
---------------------------------------------------------------------------
|                                  32位确认序号                              |
---------------------------------------------------------------------------
|4首部长度|保留(6)|URG|ACK|PSH|RST|SYN|FIN|                16位窗口大小       |
---------------------------------------------------------------------------
|         16位检验和                      |            16位紧急指针           |
---------------------------------------------------------------------------
|                                       选项                                 |
---------------------------------------------------------------------------
|                                       数据                                 |
---------------------------------------------------------------------------
```
* 源端和目的端的端口号，用于寻找发端和收端应用进程。这两个值加上IP首部中的源端IP地址和目的端IP地址唯一确定一个TCP连接。
* 序号用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的的第一
个数据字节。如果将字节流看作在两个应用程序间的单向流动，则TCP用序号对每个字节进行计数。序号是32 bit的无符号数，序号到达23^2-1后又从0开始
* 既然每个传输的字节都被计数，确认序号包含发送确认的一端所期望收到的下一个序号。因此，确认序号应当是上次已成功收到数据字节序号加1。只有ACK标志（下面介绍）为 1时确认序号字段才有效。
* 首部长度给出首部中32bit字的数目。这个字段占4bit，因此TCP最多有60字节的首部。然而，没有任选字段，正常的长度是20字节。
* URG  紧急指针
* ACK  确认序号有效
* PSH  接收方应该尽快将这个报文段交给应用层
* RST  重建连接
* SYN  同步序号用来发起一个连接。
* FIN  发端完成发送认为。
* TCP的流量控制由连接的每一端通过声明的窗口大小来提供。窗口大小为字节数，起始
于确认序号字段指明的值，这个值是接收端正期望接收的字节。窗口大小是一个16bit字段，因而窗口大小最大为65535字节。
* 检验和覆盖了整个的TCP报文段：TCP首部和TCP数据。这是一个强制性的字段，一定是
由发端计算和存储，并由收端进行验证。TCP检验和的计算和UDP检验和的计算相似。
* 只有当URG标志置1时紧急指针才有效。紧急指针是一个正的偏移量，和序号字段中的值
相加表示紧急数据最后一个字节的序号。TCP的紧急方式是发送端向另一端发送紧急数据的一种方式。
* 最常见的可选字段是最长报文大小，又称MSS(Maximum Segment Size)。每个连接方通常都在通信的第一个报文段（为建立连接而设置SYN标志的那个段)中指明这个选项。它指明本端所能接收的最大长度的报文段。

二、UDP与TCP的区别
* TCP是面向连接的，而UDP是无连接的
* UDP使用最大努力交付，即不保证可靠交付，TCP提供可靠的服务，TCP协议通过确认和重传机制来保证数据传输的可靠性。
* TCP提供了拥塞控制、滑动窗口来保证传输的质量，而UDP没有
* UDP是面向报文的，无论应用程序交给UDP层多长的报文，UDP都不会对数据报进行任何拆分等处理，因此UDP保留了应用层数据的边界；TCP是基于字节流的，将数据看作无结构的字节流进行传输，当应用程序交给TCP的数据长度太长，超过MSS时，TCP就会对数据进行分段，因此TCP的数据是无边界的。

三、TCP将用户数据打包构成报文段；它发送数据后启动一个定时器，另一端对收到的数据进行确认，对失序的数据重新排序，丢弃重复数据；TCP提供端到端的流量控制，并计算和验证一个强制性的端到端检验和。

四、建立连接协议
* 请求端（通常称为客户）发送一个SYN段指明客户打算连接的服务器的端口，以及初始序号（ISN）。
* 服务器发回包含服务器的初始序号的SYN报文段作为应答。同时，将确认序号设置为客户的ISN加1以对客户的SYN报文段进行确认。一个SYN将占用一个序号。
* 客户必须将确认序号设置为服务器的ISN加1以对服务器的SYN报文段进行确认。

五、终止连接协议

建立一个连接需要三次握手，而终止一个连接要经过4次握手。这由TCP的半关闭(half-close)造成的。既然一个TCP连接是全双工（即数据在两个方向上能同时传递），因此每个方向上必须单独地进行关闭。这原则就是当一方完成它的数据发送任务后就能发送一个FIN来终止那个方向的数据传送。发送FIN通常是应用层进行关闭的结果。

收到一个FIN只意味着在这一方向上没有数据流动。一个TCP连接在收到一个FIN后仍能发送数据。而这对利用半关闭的应用来说是可能的。

首先进行关闭的一方（即发送第一个FIN）将执行主动关闭，而另一方（收到这个FIN）执行被动关闭。通常一方完成主动关闭而另一方完成被动关闭。

各种网络设备
-----------
一、网桥

网桥是一种链路层产品，能够记录终端主机的MAC地址和端口的对应，生成MAC表。网桥能够进行冲突域隔离，有效的提高网络带宽利用率，不同接口之间的数据不会相互冲突。

网桥的缺点：接口比较有限，默认是两个接口，对网络的冲突域隔离比较有限，网桥没有专用的硬件而是采用CPU来处理数据，所有处理速度相对慢。

二、交换机

交换机(Switch)是网桥演变过来的，所以也是一种链路层产品，交换机一般是用在局域网内数据传送，但是也有广域网交换机。交换机可以隔离冲突域，但是不能隔离广播域。

与网桥相比，交换机的优势：
* 接口数量更多
* 采用专用的ASIC硬件芯片进行高速转发，所以速度更快
* 能够进行VLAN隔离（不仅仅可以隔离冲突域，通过VLAN可以隔离广播域）

一、交换机的作用

当交换机接收到数据时，它会检查数据的目的MAC地址，然后把数据从目的主机所在的接口转发出去。交换机之所以能实现这一功能，是因为内部有一个MAC地址列表，MAC地址表记录了网络中所有MAC地址与该交换机各端口的对应信息。某一数据帧需要转发时，交换机根据该数据帧的目的MAC地址来查找MAC地址列表，从而得到该地址对应的端口，即知道具有该MAC地址的设备是连接在交换机的哪个端口上，然后交换机把数据帧从该端口转发出去。

二、交换机的工作原理
1. 交换机根据收到数据帧中的源MAC地址建立该地址同交换机端口的映射，并将其写入MAC地址表中；
2. 交换机将数据帧中的目的MAC地址同已建立的MAC地址表进行比较，以决定由哪个端口进行转发。
3. 如数据帧中的目的MAC地址不在MAC地址表中，则向所有端口转发。这一过程称为泛洪。
4. 广播帧和组播帧向所有的端口转发。

三、交换机的三个主要功能

1.学习：

以太网交换机了解每一端口相连设备的MAC地址，并将地址同相应的端口映射起来存放在交换机缓存中的MAC地址表中。

2.转发/过滤：

当一个数据帧的目的地址在MAC地址表中有映射时，它被转发到连接目的节点的端口而不是所有端口（如该数据帧为广播/组播帧则转发至所有端口）

3.消除回路:

当交换机包括一个冗余回路时，以太网交换机通过生成树协议避免回路的产生，同时允许存在后备路径。

四、交换机的工作特性
1.交换机的每一个端口所连接的网段都是一个独立的冲突域。

2.交换机所连接的设备仍然在同一个广播域内，也就是说，交换机不隔绝广播（唯一的例外是在配有VLAN的环境中）

3.交换机依据帧头的信息转发，因此说交换机是工作在数据链路层的网络设备

五、交换机和路由器的区别
1.最初的交换机工作在OSI开放式系统互联模型的数据链路层，也就是第二层，而路由器则工作在OSI模型的网络层，就是第三层。

2.交换机是根据MAC地址转发数据帧，而路由器则是根据IP地址来转发IP数据报/分组。

3.分工不同：交换机主要是用于组件局域网，而路由器则是负责让主机连接外网。

六、交换机具有动态学习源MAC地址的功能，并且交换机的一个接口可以对应多个MAC地址，但是一个MAC地址只能对应一个接口

网关（Gateway）
-------
一、网关又称网间连接器、协议转换器。网关在传输层上以实现网络互联，是最复杂的网络互连设备，仅用于两个高层协议不同的网络连接。网关是一种充当转换重任的计算机系统或设备。在使用不同的通信协议、数据格式或语言，甚至体系结构完全不同的两种系统之间，网关是一个翻译器。与网桥只是简单地传送信息不同，网关对收到的信息要重新打包，以适应目的系统的需求。

二、在现代网络术语中，网关与路由器的定义不同。网关能在不同协议间移动数据，而路由器是在不同网络间移动数据，相当于传统所说的IP网关。

三、对于以太网中的网关只能转发三层以上数据包，这一点和路由是一样的。而不同的是网关中并没有路由表，他只能按照预先设定的不同网段来进行转发。网关最重要的一点就是端口映射，子网内用户在外网看来只是外网的IP地址对应着不同的端口，这样看来就会保护子网内的用户。 

四、与网桥只是简单地传达信息不同，网关对收到的信息要重新打包，以适应目的系统的需求。同时，网关也可以提供过滤和安全功能。大多数网关运行在OSI 7层协议的顶层--应用层。

SNAT和DNAT
----------
SNAT：Source Network Address Translation，是修改网络包源ip地址的。
DNAT：Destination Netword Address Translation，是修改网络包目的ip地址的。

修改源ip地址的目的一般都是为了让这个包能再回到自己这里，所以在iptables中，SNAtch是在出口，也即POSTROUTING链发挥作用。

修改目的ip地址的原因一般就是为了改变包发送的目的地，让包走出去，而不是留下了，所以在iptables中，DNAT在入口，也即PREROUTING链中发挥作用，以便让包进入FORWARD表。

iptables的表与链
----------

iptables具有Filter，NAT，Mangle和Raw四种内建表

1. Filter表
Filter表示iptables的默认表，因此如果你没有自定义表，那么就默认使用filter表，它具有以下三种内建链：
* INPUT链-处理来自外部的数据
* OUTPUT链-处理向外发送的数据
* FORWARD链-将数据转发到本机的其他网卡设备上
2. NAT表
NAT表有三种内建链：
* PREROUTING链-处理刚到达本机并在路由转发前的数据包。它会转发数据包中的目标IP地址（destination ip address），通常用于DNAT(destination NAT).
* POSTROUTING链-处理即将离开本机的数据包。它会转换数据包中的源IP地址（source ip address），通常用于SNAT（source NAT）。
* OUTPUT链-处理本机产生的数据包
3. Mangle表
Mangle表用于指定如何处理数据包。它能改变TCP头中的QoS位。Mangle表具有5个内建链：
* PREROUTING
* OUTPUT
* FORWARD
* INPUT
* POSTROUTING
4. Raw表
Raw表用于处理异常，它具有2个内建链：
* PREROUTING chain
* OUTPUT chain

IPTABLES规则(Rules)
--------
* Rules包括一个条件和一个目标（target）
* 如果满足条件，就执行目标（target）中的规则或者特定值。
* 如果不满足条件，就判断下一条。

目标值
------
* ACCEPT - 允许防火墙接收数据包
* DROP - 防火墙丢弃包
* QUEUE - 防火墙将数据包移交到用户空间
* RETURN - 防火墙停止执行当前链中的后续Rules，并返回到调用链(the calling chain)中。
* 