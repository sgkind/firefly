各种网络设备
===

## 背景知识
### 二层转发
在链路层，根据报文的目的MAC地址来对报文进行转发，因为是在链路层，我们称为二层转发。二层转发过程中不用对报文的头部做任何的修改。

### 三层转发
三层转发则是根据报文的IP地址来进行转发，并且要对报文的二层头部进行相应的修改。

### 桥接
把两台在同一网段的设备通过网桥连接在一起，因为网桥就是一台二层转发的是设备，通俗的讲就是根据目的MAC地址把一台设备上的报文原封不动的送给对应的另一台设备，所以说网桥设备在整个链路上是透明的。

### FDB表
每个桥内都会维护一张转发信息表(FDB)，转发表项包含如下信息：
* MAC 设备的MAC地址
* port 该设备连接在交换机的哪个端口

网桥收到报文后根据目的MAC查到表项就知道报文的出端口，直接转发出去即可.

### MAC地址学习
网桥启动时，桥内部维护的转发信息表（FDB表）是空的。网桥设备每接收到一个报文后，就会根据报文的源MAC地址及报文接收端口，来更新FDB表。

### FDB表项的老化
每个网桥里维护着一份FDB表，里面存着很多表项。为了防止长时间不用的表项及无效的表项占着内存，需要定时的清理这些表项。我们称之为FDB表项的老化。

### 未知单播
报文进入桥里，在FDB表中没有查到该报文的目的MAC,这时桥就不知道把该报文从哪个具体的端口转发出去。这样的报文就称作未知单播

### 泛洪(flood)
网桥处理广播报文及未知单播的方法，即把报文从桥里的每个端口发送一份出去，但不往该报文的源端口发送。

### 混杂模式
端口的一种状态，端口可以接收目的MAC不是该端口MAC的报文。一般端口默认是只接收目的MAC是该端口MAC的报文，但要进行二层转发，端口是要求接收目的MAC不是该端口的MAC,这时就要把端口模式设置为混杂模式。

### 二层口
二层口是指只具有二层转发功能的端口。从开发者角度来说，二层口和三层口在内核中都对应了一个net_device，但二层口是没有配置ip地址并且端口设置为混杂模式，并且加入网桥的端口。

### 三层交换技术
三层交换（也称多层交换技术，或IP交换技术）是相对于传统交换概念而提出的。众所周知，传统的交换技术是在OSI网络标准模型中的第二层——数据链路层进行*作的，而三层交换技术是在网络模型中的第三层实现了数据包的高速转发。简单地说，三层交换技术就是：二层交换技术＋三层转发技术。

三层交换技术的出现，解决了局域网中网段划分之后，网段中子网必须依赖路由器进行管理的局面，解决了传统路由器低速、复杂所造成的网络瓶颈问题。

其原理是：假设两个使用IP协议的站点A、B通过第三层交换机进行通信，发送站点A在开始发送时，把自己的IP地址与B站的IP地址比较，判断B站是否与自己在同一子网内。若目的站B与发送站A在同一子网内，则进行二层的转发。若两个站点不在同一子网内，如发送站A要与目的站B通信，发送站A要向“缺省网关”发出ARP(地址解析)封包，而“缺省网关”的IP地址其实是三层交换机的三层交换模块。当发送站A对“缺省网关”的IP地址广播出一个ARP请求时，如果三层交换模块在以前的通信过程中已经知道B站的MAC地址，则向发送站A回复B的MAC地址。否则三层交换模块根据路由信息向B站广播一个ARP请求，B站得到此ARP请求后向三层交换模块回复其MAC地址，三层交换模块保存此地址并回复给发送站A,同时将B站的MAC地址发送到二层交换引擎的MAC地址表中。从这以后，当A向B发送的数据包便全部交给二层交换处理，信息得以高速交换。由于仅仅在路由过程中才需要三层处理，绝大部分数据都通过二层交换转发，因此三层交换机的速度很快，接近二层交换机的速度，同时比相同路由器的价格低很多。

## 网络设备
### 网桥
网桥工作在第二层，是一种链路层产品，能够记录终端主机的MAC地址和端口的对应，生成MAC表。网桥能够进行冲突域隔离，有效的提高网络带宽利用率，不同接口之间的数据不会相互冲突。

网桥会自己进行MAC学习，来维护一张转发信息表。收到报文后用报文的目的MAC来进行查找，找到相应出端口直接把报文从出端口转发出去。如果是广播报文，就会在整个桥内进行广播，从桥中每个端口发送一份出去（报文源端口除外）。如果查找转发信息表后没找到相应的表项，就在桥内进行泛洪，即从桥中每个端口发送一份出去（报文源端口除外）。这样使连接在每个端口的设备都能收到一份报文，如果相应设备发现是到本节设备的报文，就进行处理。其他设备发现不是到本机的报文，就直接丢弃了。

网桥的缺点：接口比较有限，默认是两个接口，对网络的冲突域隔离比较有限，网桥没有专用的硬件而是采用CPU来处理数据，所有处理速度相对慢。

### 交换机
交换机(Switch)是网桥演变过来的，所以也是一种链路层产品，交换机一般是用在局域网内数据传送，但是也有广域网交换机。交换机可以隔离冲突域，但是不能隔离广播域。

与网桥相比，交换机的优势：
* 接口数量更多
* 采用专用的ASIC硬件芯片进行高速转发，所以速度更快
* 能够进行VLAN隔离（不仅仅可以隔离冲突域，通过VLAN可以隔离广播域）

#### 交换机的作用
当交换机接收到数据时，它会检查数据的目的MAC地址，然后把数据从目的主机所在的接口转发出去。交换机之所以能实现这一功能，是因为内部有一个MAC地址列表，MAC地址表记录了网络中所有MAC地址与该交换机各端口的对应信息。某一数据帧需要转发时，交换机根据该数据帧的目的MAC地址来查找MAC地址列表，从而得到该地址对应的端口，即知道具有该MAC地址的设备是连接在交换机的哪个端口上，然后交换机把数据帧从该端口转发出去。

#### 交换机的工作原理
1. 交换机根据收到数据帧中的源MAC地址建立该地址同交换机端口的映射，并将其写入MAC地址表中；
2. 交换机将数据帧中的目的MAC地址同已建立的MAC地址表进行比较，以决定由哪个端口进行转发。
3. 如数据帧中的目的MAC地址不在MAC地址表中，则向所有端口转发。这一过程称为泛洪。
4. 广播帧和组播帧向所有的端口转发。

#### 交换机的三个主要功能
1.学习：

以太网交换机了解每一端口相连设备的MAC地址，并将地址同相应的端口映射起来存放在交换机缓存中的MAC地址表中。

2.转发/过滤：

当一个数据帧的目的地址在MAC地址表中有映射时，它被转发到连接目的节点的端口而不是所有端口（如该数据帧为广播/组播帧则转发至所有端口）

3.消除回路:

当交换机包括一个冗余回路时，以太网交换机通过生成树协议避免回路的产生，同时允许存在后备路径。

#### 交换机的工作特性
1. 交换机的每一个端口所连接的网段都是一个独立的冲突域。
2. 交换机所连接的设备仍然在同一个广播域内，也就是说，交换机不隔绝广播（唯一的例外是在配有VLAN的环境中）
3. 交换机依据帧头的信息转发，因此说交换机是工作在数据链路层的网络设备

#### 交换机和路由器的区别
1. 最初的交换机工作在OSI开放式系统互联模型的数据链路层，也就是第二层，而路由器则工作在OSI模型的网络层，就是第三层。
2. 交换机是根据MAC地址转发数据帧，而路由器则是根据IP地址来转发IP数据报/分组。
3. 分工不同：交换机主要是用于组件局域网，而路由器则是负责让主机连接外网。

### 二层、三层交换机
#### 二层交换机
二层交换技术是发展比较成熟，二层交换机属数据链路层设备，可以识别数据包中的MAC地址信息，根据MAC地址进行转发，并将这些MAC地址与对应的端口记录在自己内部的一个地址表中。

具体过程如下：
1. 当交换机从某个端口收到一个数据包，它先读取包头中的源MAC地址，这样它就知道源MAC地址的机器是连在哪个端口上；
2. 再去读取包头中的目的MAC地址，并在地址表中查找相应的端口；
3. 如表中有与这目的MAC地址对应的端口，把数据包直接复制到这端口上。

#### 三层交换机
三层交换技术就是将路由技术与交换技术合二为一的技术。在对第一个数据流进行路由后，它将会产生一个MAC地址与IP地址的映射表，当同样的数据流再次通过时，将根据此表直接从二层通过而不是再次路由，从而消除了路由器进行路由选择而造成网络的延迟，提高了数据包转发的效率。

三层交换机特点：
1. 由硬件结合软件实现数据的高速转发；
2. 不是简单的二层交换机和路由器的叠加，三层路由模块直接叠加在二层交换的高速背板总线上，突破了传统路由器的接口速率限制，速率可达几十Gbit/s。算上背板带宽，这些是三层交换机性能的两个重要参数；
3. 简洁的路由软件使路由过程简化;
4. 大部分的数据转发，除了必要的路由选择交由路由软件处理，都是又二层模块高速转发，路由软件大多都是经过处理的高效优化软件，并不是简单照搬路由器中的软件。

#### 二层交换机和三层交换机的区别
* 二层交换机：基于MAC地址
* 三层交换机：具有VLAN功能，交换和路由，基于IP，工作在网络层
* 三层交换技术：二层交换技术+三层转发技术。解决了局域网中网段划分之后，网络中子网必须依赖路由器进行管理的局面，解决了传统路由器低速、复杂所造成的网络瓶颈问题。

#### 路由器
传统地，路由器工作于OSI七层协议中的第三层，其主要任务是接收来自一个网络接口的数据包，根据其中所含的目的地址，决定转发到下一个目的地址。因此，路由器首先得在转发路由表中查找它的目的地址，若找到了目的地址，就在数据包的帧格前添加下一个MAC地址，同时IP数据包头的TTL（Time To Live）域也开始减数，并重新计算校验和。当数据包被送到输出端口时，它需要按顺序等待，以便被传送到输出链路上。

路由器在工作时能够按照某种路由通信协议查找设备中的路由表。如果到某一特定节点有一条以上的路径，则基本预先确定的路由准则是选择最优（或最经济）的传输路径。由于各种网络段和其相互连接情况可能会因环境变化而变化，因此路由情况的信息一般也按所使用的路由信息协议的规定而定时更新。

#### 二层交换机和路由器的区别
二层换机从网桥发展而来，属于OSI第二层即数据链路层设备。它根据MAC地址寻址，通过站表选择路由，站表的建立和维护由交换机自动进行。路由器属于OSI第三层即网络层设备，它根据IP地址进行寻址，通过路由表路由协议产生。交换机最大的好处是快速，由于交换机只须识别帧中MAC地址，直接根据MAC地址产生选择转发端口算法简单，便于ASIC实现，因此转发速度极高。但交换机的工作机制也带来一些问题。

1.回路

根据交换机地址学习和站表建立算法，交换机之间不允许存在回路。一旦存在回路，必须启动生成树算法，阻塞掉产生回路的端口。而路由器的路由协议没有这个问题，路由器之间可以有多条通路来平衡负载，提高可靠性。

2.负载集中

交换机之间只能有一条通路，使得信息集中在一条通信链路上，不能进行动态分配，以平衡负载。而路由器的路由协议算法可以避免这一点，OSPF路由协议算法不但能产生多条路由，而且能为不同的网络应用选择各自不同的最佳路由。

3.广播控制

交换机只能缩小冲突域，而不能缩小广播域。整个交换式网络就是一个大的广播域，广播报文散到整个交换式网络。而路由器可以隔离广播域，广播报文不能通过路由器继续进行广播。

4.子网划分

交换机只能识别MAC地址。MAC地址是物理地址，而且采用平坦的地址结构，因此不能根据MAC地址来划分子网。而路由器识别IP地址，IP地址由网络管理员分配，是逻辑地址且IP地址具有层次结构，被划分成网络号和主机号，可以非常方便地用于划分子网，路由器的主要功能就是用于连接不同的网络。

5.安全问题

虽说交换机也可以根据帧的源MAC地址、目的MAC地址和其他帧中内容对帧实施过滤，但路由器根据报文的源IP地址、目的IP地址、TCP端口地址等内容对报文实施过滤，更加直观方便。

6.介质相关

交换机作为桥接设备也能完成不同链路层和物理层之间的转换，但这种转换过程比较复杂，不适合ASIC实现，势必降低交换机的转发速度。因此目前交换机主要完成相同或相似物理介质和链路协议的网络互连，而不会用来在物理介质和链路层协议相差甚元的网络之间进行互连。而路由器则不同，它主要用于不同网络之间互连，因此能连接不同物理介质、链路层协议和网络层协议的网络。路由器在功能上虽然占据了优势，但价格昂贵，报文转发速度低。近几年，交换机为提高性能做了许多改进，其中最突出的改进是虚拟网络和三层交换。


#### 三层交换机和路由器的区别
1.主要功能不同

虽然三层交换机与路由器都具有路由功能，但不能因此而把它们等同起来。路由器不仅具有路由功能，还提供了交换机端口、硬件防火墙附加功能，其目的是使设备适用面更广、使其更加实用。

三层交换机也一样，主要功能仍是数据交换，只不过它是具备了一些基本的路由功能的交换机。三层交换机同时具备了数据交换和路由转发两种功能，但其主要功能还是数据交换；而路由器仅具有路由转发这一种主要功能。

2.主要适用的环境不一样

三层交换机的路由功能通常比较简单，因为它所面对的主要是简单的局域网连接。特性远没有路由器那么复杂。它用在局域网中的主要用途还是提供快速数据交换功能，满足局域网数据交换频繁的应用特点。

而路由器则不同，虽然也适用于局域网之间的连接，但它的路由功能更多的体现在不同类型网络之间的互联上，如局域网与广域网之间的连接、不同协议的网络之间的连接等，优势在于选择最佳路由、负荷分担、链路备份及和其他网络进行路由信息的交换等。另外，为了与各种类型的网络连接，路由器的接口类型非常丰富，而三层交换机则一般仅同类型的局域网接口，非常简单。

3.技术实现不一样

路由器和三层交换机在数据包交换操作上存在着明显区别。

路由器一般由基于网络处理器或多核的路由引擎执行数据包交换。

而三层交换机通过硬件执行数据包交换。三层交换机在对第一个数据包送控制面进行路由查找后，它将会产生一个供数据面查找的MAC地址与IP地址的映射表，当同样的数据流再次通过时，将根据此表查表通过而不是再次送控制面查路由（即“一次路由，多次交换”）。

提高了数据包转发的效率。三层交换机的路由查找是针对数据流的，它利用缓存技术，很容易利用ASIC技术来实现，因此，可以大大节约成本，并实现快速转发。

而路由器的转发采用最长匹配的方式，实现复杂，一般采用价格高昂的网络处理器或多核处理器实现，并且路由表数目庞大，成本相当高。

#### 三层交换机相对于传统路由器的优点
1.子网间传输带宽可任意分配

传统路由器每个接口连接一个子网，子网通过路由器进行传输的速率被接口的带宽所限制。而三层交换机则不同，它可以把多个端口定义成一个虚拟网，把多个端口组成的虚拟网作为虚拟网接口，该虚拟网内信息可通过组成虚拟网的端口送给三层交换机，由于端口数可任意指定，子网间传输带宽没有限制。

2.合理配置信息资源

由于访问子网内资源速率和访问全局网中资源速率没有区别，子网设置单独服务器的意义不大，通过在全局网中设置服务器群不仅节省费用，更可以合理配置信息资源。

3.降低成本

通常的网络设计用交换机构成子网，用路由器进行子网间互连。目前采用三层交换机进行网络设计，既可以进行任意虚拟子网划分，又可以通过交换机三层路由功能完成子网间通信，为此节省了价格昂贵的路由器。

4.交换机之间连接灵活

作为交换机，它们之间不允许存在回路，作为路由器，又可有多条通路来提高可靠性、平衡负载。三层交换机用生成树算法阻塞造成回路的端口，但进行路由选择时，依然把阻塞掉的通路作为可选路径参与路由选择。

#### 用途
1. 二层交换机用于小型的局域网络。在小型局域网中，广播包影响不大，二层交换机的快速交换功能、多个接入端口和低廉的价格为小型网络用户提供了很完善的解决方案。
2. 三层交换机的最重要的功能是加快大型局域网络内部的数据的快速转发，加入路由功能也是为这个目的服务的。如果把大型网络按照部门，地域等等因素划分成一个个小局域网，这将导致大量的网际互访，单纯的使用二层交换机不能实现网际互访；
3. 如单纯的使用路由器，由于接口数量有限和路由转发速度慢，将限制网络的速度和网络规模，采用具有路由功能的快速转发的三层交换机就成为首选。


#### others
一、三层交换机与路由器的主要区别之所以有人搞不清三层交换机和路由器之间的区别，最根本就是三层交换机也具有“路由”功能，与传统路由器的路由功能总体上是一致的。虽然如此，三层交换机与路由器还是存在着相当大的本质区别的，下面分别予以介绍。1. 主要功能不同 虽然三层交换机与路由器都具有路由功能，但我们不能因此而把它们等同起来，正如现在许多网络设备同时具备多种传统网络设备功能一样，就如现在有许多宽带路由器不仅具有路由功能，还提供了交换机端口、硬件防火墙功能，但不能把它与交换机或者防火墙等同起来一样。因为这些路由器的主要功能还是路由功能，其它功能只不过是其附加功能，其目的是使设备适用面更广、使其更加实用。这里的三层交换机也一样，它仍是交换机产品，只不过它是具备了一些基本的路由功能的交换机，它的主要功能仍是数据交换。也就是说它同时具备了数据交换和路由由发两种功能，但其主要功能还是数据交换；而路由器仅具有路由转发这一种主要功能。2. 主要适用的环境不一样三层交换机的路由功能通常比较简单，因为它所面对的主要是简单的局域网连接。正因如此，三层交换机的路由功能通常比较简单，路由路径远没有路由器那么复杂。它用在局域网中的主要用途还是提供快速数据交换功能，满足局域网数据交换频繁的应用特点。而路由器则不同，它的设计初哀就是为了满足不同类型的网络连接，虽然也适用于局域网之间的连接，但它的路由功能更多的体现在不同类型网络之间的互联上，如局域网与广域网之间的连接、不同协议的网络之间的连接等，所以路由器主要是用于不同类型的网络之间。它最主要的功能就是路由转发，解决好各种复杂路由路径网络的连接就是它的最终目的，所以路由器的路由功能通常非常强大，不仅适用于同种协议的局域网间，更适用于不同协议的局域网与广域网间。它的优势在于选择最佳路由、负荷分担、链路备份及和其他网络进行路由信息的交换等等路由器所具有功能。为了与各种类型的网缌?樱?酚善鞯慕涌诶嘈头浅７岣唬???憬换换?蛞话憬鐾?嘈偷木钟蛲?涌冢?浅＜虻ァ?3. 性能体现不一样 从技术上讲，路由器和三层交换机在数据包交换操作上存在着明显区别。路由器一般由基于微处理器的软件路由引擎执行数据包交换，而三层交换机通过硬件执行数据包交换。三层交换机在对第一个数据流进行路由后，它将会产生一个MAC地址与IP地址的映射表，当同样的数据流再次通过时，将根据此表直接从二层通过而不是再次路由，从而消除了路由器进行路由选择而造成网络的延迟，提高了数据包转发的效率。同时，三层交换机的路由查找是针对数据流的，它利用缓存技术，很容易利用ASIC技术来实现，因此，可以大大节约成本，并实现快速转发。而路由器的转发采用最长匹配的方式，实现复杂，通常使用软件来实现，转发效率较低。正因如此，从整体性能上比较的话，三层交换机的性能要远优于路由器，非常适用于数据交换频繁的局域网中；而路由器虽然路由功能非常强大，但它的数据包转发效率远低于三层交换机，更适合于数据交换不是很频繁的不同类型网络的互联，如局域网与互联网的互联。如果把路由器，特别是高档路由器用于局域网中，则在相当大程度上是一种浪费（就其强大的路由功能而言），而且还不能很好地满足局域网通信性能需求，影响子网间的正常通信。综上所述，三层交换机与路由器之间还是存在着非常大的本质区别的。无论从哪方面来说，在局域网中进行多子网连接，最好还选用三层交换机，特别是在不同子网数据交换频繁的环境中。一方面可以确保子网间的通信性能需求，另一方面省去了另外购买交换机的投资。当然，如果子网间的通信不是很频繁，采用路由器也无可厚非，也可达到子网安全隔离相互通信的目的。具体要根据实际需求来定
 
 
     三层交换机的最重要的目的是加快大型局域网内部的数据交换，所具有的路由功能也是为这目的服务的，能够做到一次路由
，多次转发。对于数据包转发等规律性的过程由硬件高速实现，而像路由信息更新、路由表维护、路由计算、路由
确定等功能，由软件实现。
      出于安全和管理方便的考虑，主要是为了减小广播风暴的危害，必须把大型局域网按功能或地域等因素化成一个个小的
局域网，这就使得VLAN技术在网络中得到大量应用，而不同VLAN之间的通信都要经过路由器来完成转发，
随着网间互访的不断增加。单纯使用路由器来实现网间访问，不但由于端口数量有限，而且路由速度较慢。从而
限制了网络的规模和访问速度。基于这种情况三层交换机便应用而生。三层交换机是为IP设计的，接口类型简单；
拥有很强二层包处理能力，非常适合用于大型局域网内的数据路由与交换，它既可以工作在协议第三层替代或是部分完成
传统路由器的功能，同时又具有几乎第二层交换的速度，且价格相对便宜。
      三层交换机出现最重要的目的是加快大型局域网内部的数据交换，所具有的路由功能也多是围绕这个目的而展开的，所以它的
路由功能没有同一档次的专业路由器强。毕竟在安全、协议支持等方面还有许多欠缺，并不能完全取代路由器的工作。
       在实际中的典型用法是：处于同一个局域网中的各个子网的互联以及局域网中VLAN间的路由，用三层交换机来代替路由。
而只有局域网与公网互联之间要实现跨地域的网络访问，才通过专业路由器。
     从表面上看，第三层交换机是第二层交换器与路由器的合二为一，然而这种结合并非简单的物理结合，而是各取所长的逻辑
结合。其重要表现是，当某一信息源的第一个数据流进行第三层交换后，其中的路由系统会产生一个MAC地址与IP地址的映射表，
并将该表存储起来，当同一信息源的后续数据流再次进入交换环境时，交换机将根据第一次产生并保存的地址映射表，直接从第二层
由源地址传输到目的地址，不再经过第三路由系统处理，从而消除路由选择的网络延迟。